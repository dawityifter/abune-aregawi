name: Deploy Backend

on:
  push:
    branches: [ main ]
    paths:
      - 'backend/**'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to OCI
        uses: appleboy/ssh-action@master
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          FIREBASE_SERVICE_ACCOUNT_BASE64: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_BASE64 }}
          FRONTEND_URL: ${{ secrets.FRONTEND_URL }}
          GMAIL_CLIENT_ID: ${{ secrets.GMAIL_CLIENT_ID }}
          GMAIL_CLIENT_SECRET: ${{ secrets.GMAIL_CLIENT_SECRET }}
          GMAIL_REFRESH_TOKEN: ${{ secrets.GMAIL_REFRESH_TOKEN }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          NODE_ENV: ${{ secrets.NODE_ENV }}
          PORT: ${{ secrets.PORT }}
          TWILIO_ACCOUNT_SID: ${{ secrets.TWILIO_ACCOUNT_SID }}
          TWILIO_AUTH_TOKEN: ${{ secrets.TWILIO_AUTH_TOKEN }}
          TWILIO_DRY_RUN: ${{ secrets.TWILIO_DRY_RUN }}
          TWILIO_PHONE_NUMBER: ${{ secrets.TWILIO_PHONE_NUMBER }}
          STRIPE_WEBHOOK_SECRET: ${{ secrets.STRIPE_WEBHOOK_SECRET }}
          STRIPE_SECRET_KEY: ${{ secrets.STRIPE_SECRET_KEY }}
          YOUTUBE_API_KEY: ${{ secrets.YOUTUBE_API_KEY }}
          YOUTUBE_CHANNEL_ID: ${{ secrets.YOUTUBE_CHANNEL_ID }}
          YOUTUBE_SPIRITUAL_CHANNEL_ID: ${{ secrets.YOUTUBE_SPIRITUAL_CHANNEL_ID }}
          OVERRIDE_YOUTUBE_LIVE_FLAG: ${{ secrets.OVERRIDE_YOUTUBE_LIVE_FLAG }}
        with:
          host: ${{ secrets.OCI_HOST }}
          username: ${{ secrets.OCI_USERNAME }}
          key: ${{ secrets.OCI_SSH_KEY }}
          envs: DATABASE_URL,FIREBASE_SERVICE_ACCOUNT_BASE64,FRONTEND_URL,GMAIL_CLIENT_ID,GMAIL_CLIENT_SECRET,GMAIL_REFRESH_TOKEN,JWT_SECRET,NODE_ENV,PORT,TWILIO_ACCOUNT_SID,TWILIO_AUTH_TOKEN,TWILIO_DRY_RUN,TWILIO_PHONE_NUMBER,STRIPE_WEBHOOK_SECRET,STRIPE_SECRET_KEY,YOUTUBE_API_KEY,YOUTUBE_CHANNEL_ID,YOUTUBE_SPIRITUAL_CHANNEL_ID,OVERRIDE_YOUTUBE_LIVE_FLAG
          script: |
            # Navigate to project directory
            cd /var/www/repo
            
            # Force update contents
            sudo git fetch --all
            sudo git reset --hard origin/main
            
            # Install backend dependencies
            cd backend
            
            # Create .env file from secrets
            # Use sudo tee to avoid permission issues if file is owned by root
            echo "DATABASE_URL=$DATABASE_URL" | sudo tee .env > /dev/null
            echo "FIREBASE_SERVICE_ACCOUNT_BASE64=$FIREBASE_SERVICE_ACCOUNT_BASE64" | sudo tee -a .env > /dev/null
            echo "FRONTEND_URL=$FRONTEND_URL" | sudo tee -a .env > /dev/null
            echo "GMAIL_CLIENT_ID=$GMAIL_CLIENT_ID" | sudo tee -a .env > /dev/null
            echo "GMAIL_CLIENT_SECRET=$GMAIL_CLIENT_SECRET" | sudo tee -a .env > /dev/null
            echo "GMAIL_REFRESH_TOKEN=$GMAIL_REFRESH_TOKEN" | sudo tee -a .env > /dev/null
            echo "JWT_SECRET=$JWT_SECRET" | sudo tee -a .env > /dev/null
            echo "NODE_ENV=$NODE_ENV" | sudo tee -a .env > /dev/null
            echo "PORT=$PORT" | sudo tee -a .env > /dev/null
            echo "TWILIO_ACCOUNT_SID=$TWILIO_ACCOUNT_SID" | sudo tee -a .env > /dev/null
            echo "TWILIO_AUTH_TOKEN=$TWILIO_AUTH_TOKEN" | sudo tee -a .env > /dev/null
            echo "TWILIO_DRY_RUN=$TWILIO_DRY_RUN" | sudo tee -a .env > /dev/null
            echo "TWILIO_PHONE_NUMBER=$TWILIO_PHONE_NUMBER" | sudo tee -a .env > /dev/null
            echo "STRIPE_WEBHOOK_SECRET=$STRIPE_WEBHOOK_SECRET" | sudo tee -a .env > /dev/null
            echo "STRIPE_SECRET_KEY=$STRIPE_SECRET_KEY" | sudo tee -a .env > /dev/null
            echo "YOUTUBE_API_KEY=$YOUTUBE_API_KEY" | sudo tee -a .env > /dev/null
            echo "YOUTUBE_CHANNEL_ID=$YOUTUBE_CHANNEL_ID" | sudo tee -a .env > /dev/null
            echo "YOUTUBE_SPIRITUAL_CHANNEL_ID=$YOUTUBE_SPIRITUAL_CHANNEL_ID" | sudo tee -a .env > /dev/null
            echo "OVERRIDE_YOUTUBE_LIVE_FLAG=$OVERRIDE_YOUTUBE_LIVE_FLAG" | sudo tee -a .env > /dev/null
            
            # Fix permissions so the app user can read the file
            # Assuming current user is the one running the app
            sudo chown $USER:$USER .env
            sudo chmod 600 .env
            
            sudo npm ci --production

            # Run database migrations
            sudo npx sequelize-cli db:migrate
                        
            # Clean up duplicate process if it exists
            pm2 delete backend || true

            # Restart the correct backend service
            pm2 restart abune-aregawi-backend || pm2 start src/server.js --name abune-aregawi-backend
